---
title: "an_lutzoil2_may21"
author: "Iris Arbogast & Bill Dupor"
date: "5/17/2021"
output:
  html_document:
    df_print: paged
---

```{r,echo = FALSE,message = FALSE,warning = FALSE,cache=TRUE,results="hide",include=FALSE}
#knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(message = FALSE)
#knitr::opts_chunk$set(warning = FALSE)
## This program does estimation for DEFN

# The program is written by Iris Arbogast (irisarbogast@gmail.com) 
# Federal Reserve Bank of St. Louis, April 2021
# The program is based on Stata code from Mahdi Ebsim
# The code uses state-level GDP data from the BEA and Defense Wages/Contracts 
# from Dupor and Guerrero (2017)
 

# ------------------------- Install Libraries ----------------------------------
library(haven) #This package allows R to read in .dta files
library(tidyverse) #This package reads data wrangling packages, string parsing, graphing
library(matrixcalc)
library(pracma)
library(zoo)
library(lubridate)
library(doBy)
library(plm)
library(dplyr)
library(gtsummary)
library(stargazer)
library(chron)
library(ivpack)
library(rlang)
library(panelr)
library(readxl)
library(cdlTools)
library(stats)
library(texreg)
library(plyr)
library(AER)

source("../../ram_rcode/PartialGMM2S.R")
source("../../ram_rcode/mapToMat.R")

tol <- 1e-6    #set's tolerance to decide convergence of parameter estimate
guess <- -99  
maxiter <- 1000   #maximum iteration of iterated GMM procedure
k_t <- 0         #I don't remember what this does
yy <- 10        #Bartlett window goes from -yy to yy
second <- 1      #Second moment independence if value = 1
horiz <- 4
horiz2 <- 4

#df2 <- read_dta("../data/defn_temp.dta")
#lm <- ivreg(data=df2,y~x + as.factor(fips) | as.factor(fips) + as.factor(fips)*z_nat)
#summary(lm)

df <- read_dta("../data/cleaned_census_panel.dta")
df <- df[order(df$fips,df$year),]
#df <- df %>%
#  group_by(year) %>%
#  mutate(military_nat=sum(military))

df <- df %>%
  group_by(fips) %>%
  mutate(s_mil = rmilitary_all/rmilitary_all_nat)

#df2 <- df %>%
#  filter(is.na(fips)!=1) %>%
#  group_by(fips) %>%
#  mutate(s_mil66=s_mil[year==1966])

#df$s_mil = df$s_mil[is.na(df$s_mil)]


#         s_mil2 = ifelse(year>1949 & year<1965,s_mil[year==1966],s_mil))


#df2 <- df %>%
#  group_by(fips) %>%
#  mutate(s_mil2 = s_mil[year==2006])
         
df <- df %>%
  group_by(fips) %>%
  mutate(rmil2 = s_mil*rbea_nat,
         dy  = (1/horiz)*100*((rgdp-dplyr::lag(rgdp,horiz))/dplyr::lag(rgdp,horiz)),
         dx2  =  (1/horiz)*100*((rmil2-dplyr::lag(rmil2,horiz))/dplyr::lag(rgdp,horiz)),
         Dy  = (1/horiz)*100*((rgdp-dplyr::lag(rgdp,horiz))/dplyr::lag(rgdp_nat,horiz)),
         Dy_nat = (1/horiz)*100*((rgdp_nat-dplyr::lag(rgdp_nat,horiz))/dplyr::lag(rgdp_nat,horiz)),
         Dx2  =  (1/horiz)*100*((rmil2-dplyr::lag(rmil2,horiz))/dplyr::lag(rgdp_nat,horiz)),
         Dx2_nat  =  (1/horiz)*100*((rbea_nat-dplyr::lag(rbea_nat,horiz))/dplyr::lag(rgdp_nat,horiz)),
         Dx2_spill = (1/8)*(Dx2_nat - Dx2),
         Dx2_nat50  =  (1/9)*(1/horiz)*100*((rbea_nat-dplyr::lag(rbea_nat,horiz))/dplyr::lag(rgdp_nat,horiz)),
         Fhy = 100*(zoo::rollsum(rgdp,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rgdp,1))/dplyr::lag(rgdp_nat,1),
         Fhy_nat = 100*(zoo::rollsum(rgdp_nat,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rgdp_nat,1))/dplyr::lag(rgdp_nat,1),
         Fhx2 = 100*(zoo::rollsum(rmil2,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rmil2,1))/dplyr::lag(rgdp_nat,1),
         Fhx2_nat = 100*(zoo::rollsum(rbea_nat,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rbea_nat,1))/dplyr::lag(rgdp_nat,1),
         Fhx2_nat50 = (1/50)*Fhx2_nat,
#         Dx  =  (1/horiz)*100*((rmilitary_all-dplyr::lag(rmilitary_all,horiz))/dplyr::lag(rgdp_nat,horiz)),
#         Dx_nat  =  (1/horiz)*100*((rmilitary_all_nat-dplyr::lag(rmilitary_all_nat,horiz))/dplyr::lag(rgdp_nat,horiz)),
#         Dx_nat50  =  (1/50)*(1/horiz)*100*((rmilitary_all_nat-dplyr::lag(rmilitary_all_nat,horiz))/dplyr::lag(rgdp_nat,horiz)),
         fhy = 100*(zoo::rollsum(rgdp,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rgdp,1))/dplyr::lag(rgdp,1),
         fhx2 = 100*(zoo::rollsum(rmil2,k=horiz2+1,align="left",fill=NA) -
                     (horiz2+1)*dplyr::lag(rmil2,1))/dplyr::lag(rgdp,1))
#         Dx_spill = (1/49)*(50*Dx_nat - Dx),
#         s   = dplyr::lag(gdp/gdp_nat,horiz),
#         s2 = s*s,
#         invS = 1/s,
#         Dx_nat2 = s^(3/horiz)*0.5*100*((military_all_nat-dplyr::lag(military_all_nat,horiz))/dplyr::lag(gdp_nat,horiz)))


hall <- subset(df,year>1966 & year<2008)


#IRIS!  Here it is (this is the full regression)

#Dy = y_{it}
#Dx2 = s_{it}*x_t
#Dx2_spill = (1-s_{it})*x_t
#Dx2_nat = x_t
#Switch to an "Aggregable function" own slope identical across groups and aggregte slopes state specific
full_regression <- lm(data=hall,Dy ~ as.factor(fips) + Dx2  + Dx2_spill - 1)
summary(full_regression)

partial_regression <- lm(data=hall,Dy ~ as.factor(fips) + Dx2  - 1)
#NEXT, SAVE RESIDUAL, resid

#Scatter resid agaisnt Dx2_spill (no weighting, small circles, red means low x, green means high x)

```


```{r}

agg_regression <- lm(data=subset(hall,fips==1),Dy_nat ~ Dx2_nat)
summary(agg_regression)


```